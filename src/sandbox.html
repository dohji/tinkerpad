<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Security-Policy" content="
  default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;
  script-src * 'unsafe-inline' 'unsafe-eval' data: blob:;
  style-src * 'unsafe-inline' data: blob:;
  connect-src * data: blob:;
  img-src * data: blob:;
  font-src * data: blob:;
">
</head>
<body>
  <script>
    // console shim to forward logs back to parent
    (function(){
      function send(level, args){
        try {
          parent.postMessage({ kind: 'tinkerpad:console', level, args }, '*');
        } catch(e){}
      }
      ['log','info','warn','error','debug'].forEach(fn=>{
        const orig = console[fn];
        console[fn] = function(){
          send(fn, Array.from(arguments).map(a => {
            try { return (typeof a === 'object') ? JSON.stringify(a) : String(a); }
            catch(e){ return String(a); }
          }));
          orig.apply(console, arguments);
        };
      });
      window.onerror = function(msg, src, ln, col, err){
        send('error', [msg + ' (line:' + ln + ')']);
      };
    })();

    // listen for code from parent
    window.addEventListener('message', ev => {
      const data = ev.data;
      if (data.kind === 'tinkerpad:run') {
        const { code, libraries } = data;

        // remove any existing library scripts
        document.querySelectorAll('script[data-lib]').forEach(s => s.remove());

        // load libraries
        if (libraries && libraries.length) {
          libraries.forEach(url => {
            const s = document.createElement('script');
            s.src = url;
            s.dataset.lib = "true";
            document.body.appendChild(s);
          });
        }

        // run user code after a short delay
        setTimeout(() => {
          try {
            new Function(code)();
          } catch(e) {
            console.error(e && e.stack ? e.stack : e);
          }
        }, 200);
      }
    });
  </script>
</body>
</html>